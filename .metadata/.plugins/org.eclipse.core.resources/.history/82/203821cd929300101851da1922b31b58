<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ include file="op_top.jsp" %>
<%
String idx = request.getParameter("idx");
String passinput = request.getParameter("passinput");

Connection conn = null;
PreparedStatement pstmt = null;
ResultSet rs = null;
String check = "";
String sql = "";

try {
    conn = DB.getConnection();

    if (login_id == null || login_id.equals("")) {
        // For non-logged-in users
        sql = "SELECT pwd FROM board WHERE idx = ?";
        pstmt = conn.prepareStatement(sql);
        pstmt.setString(1, idx);
        
        rs = pstmt.executeQuery();
        if(rs.next()){
            check = rs.getString("pwd");
        }
    } else {
        // For logged-in users
        sql = "SELECT m.upassword AS pass FROM board b JOIN member m ON b.uid = m.uid WHERE b.idx = ?";
        pstmt = conn.prepareStatement(sql);
        pstmt.setString(1, idx);
        
        rs = pstmt.executeQuery();
        if(rs.next()){
            check = rs.getString("pass");
        }
    }
} catch (Exception e) {
    e.printStackTrace();
    // Handle error gracefully
} finally {
    // Always close resources
    if (rs != null) try { rs.close(); } catch (SQLException e) {}
    if (pstmt != null) try { pstmt.close(); } catch (SQLException e) {}
    if (conn != null) try { conn.close(); } catch (SQLException e) {}
}

if (passinput != null && passinput.equals(check)) {
    // Password matches
%>
    <script type="text/javascript">
        location.replace("modify.jsp?idx=<%= idx %>");
    </script>
<%
} else {
    // Password does not match
%>
    <script type="text/javascript">
        alert("비밀번호가 틀렸습니다.");
        location.replace("view.jsp?idx=<%= idx %>");
    </script>
<%
}
%>