<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page import="java.sql.*"%>    
<%@ page import="lib.DB" %>
<%@page import="java.io.File"%>
<%
String login_id = "";
login_id = (String)session.getAttribute("ss_check");
%>
<%
String idx = request.getParameter("idx");
String delpass = request.getParameter("delpass");
String uid = null;
String pass = null;

String sql = "";
Connection conn=null;
PreparedStatement ps = null;
ResultSet rs = null;

try{
    conn = DB.getConnection();
    {
    	sql = "SELECT b.*, m.upassword as pass FROM board b LEFT JOIN member m ON b.uid = m.uid where b.idx=?";
    	ps = conn.prepareStatement(sql);
    	ps.setString(1, idx);
		rs = ps.executeQuery();
		rs.next();
		uid = rs.getString("uid");
		pass = rs.getString("pass");
    }
    
    if(login_id == null || !login_id.equals(uid))
    {
    	%>
    	<script>
    	alert("글을 작성한 계정이 아닙니다.");
    	location.replace("view.jsp?idx=<%= idx %>");
    	</script>
    	<%
    	return;
    }
    
    if(delpass == null || !delpass.equals(pass))
    {
    	%>
    	<script>
    	alert("비밀번호가 틀렸습니다.");
    	location.replace("view.jsp?idx=<%= idx %>");
    	</script>
    	<%
    	return;
    }
    
    String upfile = "";
  	String originaldir = "";
    
    {
    	sql = "select * from board where idx=?";
		 ps = conn.prepareStatement(sql);
		 
		 ps.setString(1, idx);
		 rs = ps.executeQuery();
		 rs.next();
		 upfile = rs.getString("upfile");
		 originaldir = rs.getString("originaldir");
		 if (upfile != null) {
			 String del_file = originaldir+"\\"+upfile;
			 System.out.println(del_file+" del");
			 File file = new File(del_file);
			 
			 if( file.exists() ){
		    		if(file.delete()){
		    			//System.out.println("파일삭제 성공");
		    		}else{
		    			//System.out.println("파일삭제 실패");
		    		}
		 		}
			 }
    }

   sql = " delete from board where idx ='"+idx+"' ";

   Statement st = conn.createStatement();

   st.executeUpdate(sql);

   %>
	<script>
		alert("삭제 성공");
		location.replace("list.jsp");
	</script>
	<%
   
   //response.sendRedirect("list.jsp");
    
  }catch(Exception e){ 
    e.printStackTrace();
    out.println(sql);
  }finally {
	  	if (rs != null){
		   rs.close();
		}
	  	
	  	if (ps != null){
			   ps.close();
			}

		if (conn != null){
		   conn.close();
		}
  }

%>